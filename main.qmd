---
title: "TFG"
format: html
editor: source
---

# Librerías

```{r}
#| warning: false
rm(list = ls())
library(pdftools)
library(tidyverse)
library(readxl)
library(zoo)
```

```{r}
theme_tfg <- theme_minimal() +
  theme(axis.title.x = element_blank(),
        axis.text = element_text(color = "black"),
        axis.line.x.bottom = element_line(color = "black"),
        axis.line.y.left = element_line(color = "black"),
        axis.ticks.y  = element_line(color = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())
```

# Carga de los Datos

Los datos se han obtenido de la [Massachussets DESE](https://hdl.handle.net/2452/833423), donde los institutos públicos de Massachusetts informaban de forma semanal el número de casos Covid-19 detectados entre el alumnado y el profesorado. Se ha descargado los reportes correspondientes a las 40 semanas del año escolar del curso 2021-2022, el último reporte analizado data del 16 de junio.

Los reportes constan de la siguiente estructura:

-   La primera página se corresponde a un resumen de los resultados obtenidos.

-   A partir de la segunda página se listan los distritos junto al número de positivos entre el alumnado y el profesorado, así como el número de pruebas de grupo rutinarias, el número de positivos y su ratio.

-   A continuación, se muestra una tabla con los casos registrados en las organizaciones educativas colaboradoras.

-   Finalmente, se listan los casos registrados en los colegios aprobados de educación especial.

De este modo, el objetivo será extraer la información de las tablas correspondientes a la información de los distritos. Para ello, se ha implementado el siguiente código:

1.  **Listado de los archivos.** Se lista el nombre de los archivos pdf contenidos en la carpeta data/reportes_covid. También se extraerá la fecha contenida en el nombre:

```{r}
archivos <- list.files("data/reportes_covid",pattern = ".pdf")
```

2.  **Extracción de los datos.** Implementamos una función que permita extraer la información deseada.

La función recibe cómo parámetro un iterable con el nombre de los archivos y devuelve un dataframe con los datos correspondientes al código del distrito, nombre del distrito, número de casos covid-19 en alumnos, número de casos covid-19 en profesores, número de pruebas de grupo rutinarias, número de positivos y ratio positivos/pruebas.

```{r}
#| warning: false
obt_data_distritos <- function(archivos){
  
  fechas <- str_extract(string = archivos, pattern = "\\d{4}-\\d{1,2}-\\d{1,2}")
  
  df <- data.frame(Code = NA, Name = NA, Students = NA, Staff = NA, PT = NA, PPT = NA, PPR = NA, Date = NA)
  
  for(i in 1:length(archivos)){
  
  df2 <- pdf_text(paste0("data/reportes_covid/",archivos[i]))
  
  p <- 2
  
  fin <- FALSE
  
  while(fin == FALSE){
    if(p == 2){
      aux <- df2[[p]] %>%
        str_split("\n") %>%
        as_tibble(.name_repair=make.names)
      aux <- aux %>%
        slice(7:nrow(aux)) %>%
        separate(X, into = c("Code","Name","Students","Staff","PT","PPT","PPR"), sep = "\\s{2,}")%>%
      filter(Code != "") %>% 
        mutate(Date = fechas[i])
      
    }else{
      aux <- df2[[p]] %>%
      str_split("\n") %>%
      as_tibble(.name_repair=make.names) %>%
      separate(X, into = c("Code","Name","Students","Staff","PT","PPT","PPR"), sep = "\\s{2,}") %>%
      filter(Code != "") %>% 
        mutate(Date = fechas[i])
    }
    df <- rbind(df,aux)
    
    p = p + 1
    
    fin <- grepl(pattern = "Education Collaboratives",df2[[p]])
  }
  
  }
  
  return(df)
}

df <- obt_data_distritos(archivos)
```

3.  **Adecuación de las variables**. Se convierten al tipo adecuado las variables obtenidas y eliminamos las filas que contenga en la variable `Code` NAs.

```{r}
#| warning: false
df <- df %>%
  mutate(Students = as.numeric(Students),
         Staff = as.numeric(Staff),
         PT = as.numeric(PT),
         PPT = as.numeric(PPT),
         Date = as.Date(Date)) %>%
  filter(!is.na(Code))
```

# Selección de los distritos escolares

```{r}
selected_districts <- read_delim("data/selected_districts.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)
selected_districts$Week <- as.factor(selected_districts$Week)
```

```{r}
df <- df %>% 
  filter(Code %in% selected_districts$Code)

length(unique(df$Name))
```

```{r}
sum(df$Students[df$Date >= as.Date("2022-03-03")]) + sum(df$Staff[df$Date >= as.Date("2022-03-03")])
```

# Preparación de los datos

```{r}
df_stu <- df %>% 
  select(Code,Students,Date) %>%
  pivot_wider(names_from = Code,values_from = Students) %>%
  arrange(Date)

for(f in 2:nrow(df_stu)){
  if(df_stu$Date[f] - df_stu$Date[f-1] >= 14){
    sem_imp <- cbind(Date = df_stu$Date[f] - 7,df_stu[df_stu$Date == df_stu$Date[f],2:73] / 2)
    df_stu[df_stu$Date == df_stu$Date[f],2:73] <- df_stu[df_stu$Date == df_stu$Date[f],2:73] / 2
    df_stu <- rbind(df_stu,sem_imp)
  }
}

df_stu <- df_stu %>% arrange(Date)

fecha <- df_stu$Date

df_stu <- as.data.frame(apply(df_stu %>% select(-Date),2,function(x){
  for(f in 2:length(x)){
    if(x[f] > 1 & x[f-1] == 0){
      x[f-1] <- x[f]/2
      x[f] <- x[f]/2
    }
  }
  return(x)
}))

df_stu <- cbind(Date = fecha, df_stu)

df_stu <- df_stu %>% arrange(Date)

df_stu_smooth <- as.data.frame(apply(df_stu %>% select(-Date), 2, function(x){rollapply(floor(x),3,mean,align='center',fill=NA, partial = TRUE)}))
df_stu_smooth <- cbind(df_stu_smooth,Date = df_stu$Date)
df_stu_smooth <- df_stu_smooth %>% 
  pivot_longer(-73,names_to = "Code",values_to = "Students") %>% 
  filter(!is.na(Students))
df_stu_smooth$Students <- floor(df_stu_smooth$Students)

sum(df_stu_smooth$Students[df_stu_smooth$Date >= as.Date("2022-03-03")])
```

```{r}
df_staff <- df %>% 
  select(Code,Staff,Date) %>%
  pivot_wider(names_from = Code,values_from = Staff) %>% 
  arrange(Date)


for(f in 2:nrow(df_staff)){
  if(df_staff$Date[f] - df_staff$Date[f-1] >= 14){
    sem_imp <- cbind(Date = df_staff$Date[f] - 7,df_staff[df_staff$Date == df_staff$Date[f],2:73] / 2)
    df_staff[df_staff$Date == df_staff$Date[f],2:73] <- df_staff[df_staff$Date == df_staff$Date[f],2:73] / 2
    df_staff <- rbind(df_staff,sem_imp)
  }
}

df_staff <- df_staff %>% arrange(Date)

fecha <- df_staff$Date

df_staff <- as.data.frame(apply(df_staff %>% select(-Date),2,function(x){
  for(f in 2:length(x)){
    if(x[f] > 1 & x[f-1] == 0){
      x[f-1] <- x[f]/2
      x[f] <- x[f]/2
    }
  }
  return(x)
}))

df_staff <- cbind(Date = fecha, df_staff)
df_staff <- df_staff %>% arrange(Date)

df_staff_smooth <- as.data.frame(apply(df_staff %>% select(-Date), 2, function(x){rollapply(floor(x),3,mean,align='center',fill=NA, partial = TRUE)}))
df_staff_smooth <- cbind(df_staff_smooth,Date = df_staff$Date)
df_staff_smooth <- df_staff_smooth %>% 
  pivot_longer(-73,names_to = "Code",values_to = "Staff") %>% 
  filter(!is.na(Staff))
df_staff_smooth$Staff <- round(df_staff_smooth$Staff)

sum(df_staff_smooth$Staff[df_staff_smooth$Date >= as.Date("2022-03-03")])
```

```{r}
sum(df_staff_smooth$Staff[df_staff_smooth$Date >= as.Date("2022-03-03")]) + sum(df_stu_smooth$Students[df_stu_smooth$Date >= as.Date("2022-03-03")])
```

```{r}
df_smooth <- left_join(df_staff_smooth,df_stu_smooth,by = c("Code","Date")) %>% 
  mutate(Total = Staff + Students)

df_smooth
```

```{r}
df_smooth <- left_join(df_smooth,selected_districts %>% select(-Name))
df_smooth
```

```{r}
ClassSizebyRaceEthnicity <- read_excel("data/ClassSizebyRaceEthnicity.xlsx", 
    skip = 1)

glimpse(ClassSizebyRaceEthnicity)

ClassSizebyRaceEthnicity[,3:12] <- apply(ClassSizebyRaceEthnicity[,3:12], 2, function(x){as.numeric(str_remove(x,","))})
ClassSizebyRaceEthnicity <- ClassSizebyRaceEthnicity[,1:9]
glimpse(ClassSizebyRaceEthnicity)
```

```{r}
df_smooth <- df_smooth %>% left_join(ClassSizebyRaceEthnicity %>% select(`District Code`,`Number of Students`), by = c("Code"="District Code"))
```


```{r}
df_smooth_grouped <- df_smooth %>% 
  group_by(Week,Date) %>% 
  summarise(Staff = sum(Staff), Students = sum(Students), Total = sum(Total), `Number of Students` = sum(`Number of Students`)) %>% 
  mutate(Students1000 = Students / `Number of Students` * 1000)

df_smooth_grouped
```

```{r}
df_smooth_grouped %>% 
  ggplot(aes(x = Date, y = Students1000, color = Week)) +
  geom_point() +
  geom_line() +
  #scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(breaks=seq(0,35,5), expand = c(0.01, 0)) +
  theme_tfg 
```

# Otros indicadores

```{r}
ClassSizebyRaceEthnicity <- read_excel("data/ClassSizebyRaceEthnicity.xlsx", 
    skip = 1)

glimpse(ClassSizebyRaceEthnicity)
```
```{r}
ClassSizebyRaceEthnicity[,3:12] <- apply(ClassSizebyRaceEthnicity[,3:12], 2, function(x){as.numeric(str_remove(x,","))})
ClassSizebyRaceEthnicity <- ClassSizebyRaceEthnicity[,1:9]
glimpse(ClassSizebyRaceEthnicity)
```

```{r}
ClassSizebyGenPopulation <- read_excel("data/ClassSizebyGenPopulation.xlsx", 
    skip = 1)

glimpse(ClassSizebyGenPopulation)
```

```{r}
ClassSizebyGenPopulation[,3:10] <- apply(ClassSizebyGenPopulation[,3:10], 2, function(x){as.numeric(str_remove(x,","))})
glimpse(ClassSizebyGenPopulation)
```

Seleccionamos los distritos estudiados

```{r}
ClassSizebyRaceEthnicity <- ClassSizebyRaceEthnicity %>% inner_join(selected_districts %>% select(Code,Week), by = c("District Code" = "Code"))
ClassSizebyGenPopulation <- ClassSizebyGenPopulation %>% inner_join(selected_districts %>% select(Code,Week), by = c("District Code" = "Code"))
```

```{r}
#| warning: false
ClassSizebyRaceEthnicity$african_scale <- scale(ClassSizebyRaceEthnicity$`African American %`)[,1]
ClassSizebyRaceEthnicity$asian_scale <- scale(ClassSizebyRaceEthnicity$`Asian %`)[,1]
ClassSizebyRaceEthnicity$hispanic_scale <- scale(ClassSizebyRaceEthnicity$`Hispanic %`)[,1]
ClassSizebyRaceEthnicity$white_scale <- scale(ClassSizebyRaceEthnicity$`White %`)[,1]

ClassSizebyRaceEthnicity %>% 
  pivot_longer(11:14,names_to = "names",values_to = "values") %>%
  ggplot(aes(x = names, y = values, fill = Week)) +
  geom_hline(yintercept = 0, color = "grey", linetype = 2, size = 0.8) +
  geom_point(aes(color = Week), position = position_jitterdodge(jitter.width = 0.2), alpha = 0.4) +
  geom_boxplot(outliers = FALSE, alpha = 0.4) +
  stat_summary(aes(color = Week), fun.y="mean", shape=23, position = position_jitterdodge(jitter.width = 0)) +
  scale_y_continuous(breaks=seq(-3,6,1), limits = c(-2,6)) +
  scale_x_discrete(labels=c("african_scale" = "Porcentaje\nNegros",
                            "asian_scale" = "Porcentaje\nAsiáticos",
                            "hispanic_scale" = "Porcentaje\nHispanos",
                            "white_scale" = "Porcentaje\nBlancos")) +
  labs(y = "Valores Escalados de la Variable", title = "Distribución de los Estudiantes de Acuerdo a la Raza o Grupo Étnico") +
  theme_tfg
```

```{r}
#| warning: false
ClassSizebyGenPopulation$lis_scale <- scale(ClassSizebyGenPopulation$`Economically Disadvantaged %`)[,1]
ClassSizebyGenPopulation$sd_scale <- scale(ClassSizebyGenPopulation$`Students with Disabilities %`)[,1]
ClassSizebyGenPopulation$ell_scale <- scale(ClassSizebyGenPopulation$`English Language Learner %`)[,1]

ClassSizebyGenPopulation %>% 
  pivot_longer(12:14,names_to = "names",values_to = "values") %>%
  ggplot(aes(x = names, y = values, fill = Week)) +
  geom_hline(yintercept = 0, color = "grey", linetype = 2, size = 0.8) +
  geom_point(aes(color = Week), position = position_jitterdodge(jitter.width = 0.2), alpha = 0.4) +
  geom_boxplot(outliers = FALSE, alpha = 0.4) +
  stat_summary(aes(color = Week), fun.y="mean", shape=23, position = position_jitterdodge(jitter.width = 0))+
  scale_y_continuous(breaks=seq(-2,4,1), limits = c(-2,4.5)) +
  scale_x_discrete(limits = c("lis_scale","sd_scale","ell_scale"),
                   labels=c("lis_scale" = "Porcentaje de\nEstudiantes con\nBajos Ingresos",
                            "sd_scale" = "Porcentaje de\nEstudiantes con\n Discapacidad",
                            "ell_scale" = "Porcentaje de\nEstudiantes ELL")) +
  labs(y = "Valores Escalados de la Variable", title = "Distribución de los Estudiantes en Poblaciones Seleccionadas por DESE") +
  theme_tfg
```

